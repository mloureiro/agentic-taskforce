#!/usr/bin/env bash
# shellcheck shell=bash

set -euo pipefail

# tf-claude - Spawn a Claude Code session with taskforce identity
# Sets TF_SESSION_ID env var for session tracking and optionally registers for a task

# Calculate taskforce root from script location (parent of bin/)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
TASKFORCE_ROOT="$(dirname "$SCRIPT_DIR")"

# Create absolute path format for Claude Code permissions
# Claude Code requires // prefix for absolute paths (see github.com/anthropics/claude-code/issues/16800)
TASKFORCE_ROOT_ABS="//${TASKFORCE_ROOT#/}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Build base allowed tools array (populates ALLOWED_TOOLS global)
build_base_allowed_tools() {
    ALLOWED_TOOLS=(
        # Taskforce tools
        "--allowed-tools" "Bash(tf-*)"

        # Taskforce file access (read-only)
        "--allowed-tools" "Read($TASKFORCE_ROOT_ABS/**)"

        # Git operations
        "--allowed-tools" "Bash(git diff *)"
        "--allowed-tools" "Bash(git status)"
        "--allowed-tools" "Bash(git log *)"
        "--allowed-tools" "Bash(git show *)"
        "--allowed-tools" "Bash(git branch *)"
        "--allowed-tools" "Bash(git checkout *)"
        "--allowed-tools" "Bash(git add *)"
        "--allowed-tools" "Bash(git commit *)"
        "--allowed-tools" "Bash(git push *)"

        # Common utilities
        "--allowed-tools" "Bash(ls *)"
        "--allowed-tools" "Bash(cat *)"
        "--allowed-tools" "Bash(grep *)"
        "--allowed-tools" "Bash(find *)"
        "--allowed-tools" "Bash(echo *)"
        "--allowed-tools" "Bash(sleep *)"
        "--allowed-tools" "Bash(pwd)"

        # Build tools
        "--allowed-tools" "Bash(pnpm *)"
        "--allowed-tools" "Bash(npm run *)"
        "--allowed-tools" "Bash(npx *)"

        # Project file access (current directory)
        "--allowed-tools" "Read($PWD/**)"
        "--allowed-tools" "Edit($PWD/**)"
    )
}

usage() {
    cat <<EOF
Usage: tf-claude [task-id [--claim <name>]] [--verbose] [-- claude-args...]

Boots up a Claude Code session identified to work on a taskforce.

Arguments:
    [task-id]           Identifies the task agent will work on. Initializes
                        the task if not yet done and registers the agent.

Options:
    --claim <name>      Claims existing <name> registration instead of
                        registering a new agent.
                        (can only be used if [task-id] is provided)
    --verbose, -v       Show detailed output during initialization
    --help, -h          Show this help message

Examples:
    tf-claude                           # Start session without task
    tf-claude fix-flaky-ci              # Start and register for task
    tf-claude fix-flaky-ci --claim red  # Start and claim red slot
    tf-claude fix-flaky-ci -- --resume  # Register and resume previous claude session

EOF
}

error() {
    echo -e "${RED}Error:${NC} $1" >&2
    exit 1
}

# Parse arguments
TASK_ID=""
CLAIM_NAME=""
VERBOSE=false
CLAUDE_ARGS=()

while [[ $# -gt 0 ]]; do
    case $1 in
        --help|-h)
            usage
            exit 0
            ;;
        --verbose|-v)
            VERBOSE=true
            shift
            ;;
        --claim)
            if [[ -z "$TASK_ID" ]]; then
                error "--claim can only be used when task-id is provided"
            fi
            if [[ -z "${2:-}" ]]; then
                error "--claim requires a name argument"
            fi
            CLAIM_NAME="$2"
            shift 2
            ;;
        --)
            shift
            CLAUDE_ARGS=("$@")
            break
            ;;
        -*)
            error "Unknown option: $1\nUse --help for usage information."
            ;;
        *)
            if [[ -z "$TASK_ID" ]]; then
                TASK_ID="$1"
                shift
            else
                error "Unexpected argument: $1\nUse -- to pass arguments to claude."
            fi
            ;;
    esac
done

# Generate unique session ID (8 alphanumeric chars, like git short hashes)
export TF_SESSION_ID=$(head -c 32 /dev/urandom | base64 | tr -dc 'A-Za-z0-9' | head -c 8)

# Helper for verbose output
verbose() {
    if [[ "$VERBOSE" == true ]]; then
        echo -e "$@"
    fi
}

# If no task-id, just show basic session info and spawn claude
if [[ -z "$TASK_ID" ]]; then
    echo -e "${GREEN}Taskforce session initialized${NC}"
    echo -e "  Session ID: ${BOLD}$TF_SESSION_ID${NC}"
    echo ""
    echo -e "${CYAN}Remember:${NC} Run ${BOLD}tf-register new <task-id>${NC} to join a task"
    echo ""

    build_base_allowed_tools
    exec claude "${ALLOWED_TOOLS[@]}" ${CLAUDE_ARGS[@]+"${CLAUDE_ARGS[@]}"}
fi

# Task-id provided - full initialization flow
TASK_DIR="$TASKFORCE_ROOT/$TASK_ID"
TASK_DIR_ABS="//${TASK_DIR#/}"
TASK_FILE="$TASK_DIR/TASK.md"

verbose "${GREEN}Taskforce session initialized${NC}"
verbose "  Session ID: ${BOLD}$TF_SESSION_ID${NC}"
verbose ""

# Step 1: Ensure task exists
verbose "${CYAN}Checking task...${NC}"
INIT_RESULT=$(tf-init --ensure --name "$TASK_ID" 2>&1) || {
    error "Failed to initialize task: $INIT_RESULT"
}

TASK_NEWLY_CREATED=false
if [[ "$INIT_RESULT" == "created" ]]; then
    TASK_NEWLY_CREATED=true
    verbose "  Task ${BOLD}$TASK_ID${NC} created"
else
    # Check if task exists but is empty (still has template placeholder)
    if grep -q "<!-- TODO: Add task objective here -->" "$TASK_FILE" 2>/dev/null; then
        TASK_NEWLY_CREATED=true
        verbose "  Task ${BOLD}$TASK_ID${NC} exists but is empty"
    else
        verbose "  Task ${BOLD}$TASK_ID${NC} exists"
    fi
fi

# Step 2: Register or claim
verbose ""
verbose "${CYAN}Registering agent...${NC}"

if [[ -n "$CLAIM_NAME" ]]; then
    # Claim existing slot
    CLAIM_OUTPUT=$(tf-register claim "$TASK_ID" "$CLAIM_NAME" 2>&1) || {
        echo -e "$CLAIM_OUTPUT" >&2
        error "Failed to claim '$CLAIM_NAME' for task '$TASK_ID'"
    }
    verbose "$CLAIM_OUTPUT"
    AGENT_NAME="$CLAIM_NAME"
else
    # Register new
    REGISTER_OUTPUT=$(tf-register new "$TASK_ID" 2>&1) || {
        echo -e "$REGISTER_OUTPUT" >&2
        error "Failed to register for task '$TASK_ID'"
    }
    verbose "$REGISTER_OUTPUT"
    # Extract agent name from output (line like "  Name: red")
    AGENT_NAME=$(echo "$REGISTER_OUTPUT" | grep -E "^\s*Name:" | sed 's/.*Name:[[:space:]]*//' | sed 's/\x1b\[[0-9;]*m//g')
fi

# Step 3: Output summary
verbose ""
echo -e "${GREEN}${BOLD}Ready!${NC} Session ${BOLD}$TF_SESSION_ID${NC} · Agent ${BOLD}$AGENT_NAME${NC} · Task ${CYAN}$TASK_ID${NC}"
if [[ "$TASK_NEWLY_CREATED" == true ]]; then
    echo -e "       ${YELLOW}(task newly created)${NC}"
fi
echo ""
# Step 4: Build allowed tools for autonomous operation
build_base_allowed_tools
# Add task-specific edit permission for agent's files
ALLOWED_TOOLS+=(
    "--allowed-tools" "Edit($TASK_DIR_ABS/*-$AGENT_NAME.*)"
)

# Step 5: Build prompt and spawn claude (auto-executes)
if [[ "$TASK_NEWLY_CREATED" == true ]]; then
    PROMPT="You are agent '$AGENT_NAME' assigned to the '$TASK_ID' taskforce' (session: $TF_SESSION_ID).
Read about taskforces in @$TASKFORCE_ROOT/RULES.md.
Let's discuss the task at hand at @$TASK_DIR/TASK.md"
else
    PROMPT="You are '$AGENT_NAME', assigned to the '$TASK_ID' taskforce (session: $TF_SESSION_ID).
Read the taskforce rules at @$TASKFORCE_ROOT/RULES.md
Introduce yourself: \`tf-chat add -T JOIN -m 'Hi! I will check the task and come back soon'\`
Your task is at @$TASK_DIR/TASK.md
Check the chat log for any instructions, otherwise proceed with the task."
fi

exec claude "${ALLOWED_TOOLS[@]}" -- "$PROMPT" ${CLAUDE_ARGS[@]+"${CLAUDE_ARGS[@]}"}
