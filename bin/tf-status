#!/usr/bin/env bash

set -euo pipefail

# tf-status - Taskforce status dashboard
# Shows agents, activity, requirements progress, and alerts

TASKFORCE_ROOT="${TF_ROOT:-$HOME/.agentic-taskforce}"
REGISTRY_FILE="$TASKFORCE_ROOT/bin/.registration.log"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

usage() {
    cat <<EOF
Usage: tf-status [task-id]

Show taskforce status dashboard.

Arguments:
    task-id     Task to show status for (optional if registered)

Options:
    --help, -h  Show this help message

Output includes:
    - Active agents and their last activity
    - Requirements checklist progress
    - Recent chat entries
    - Alerts (silent agents, etc.)

Examples:
    tf-status                    # Use task from registration
    tf-status fix-flaky-ci       # Specific task

EOF
}

error() {
    echo -e "${RED}Error:${NC} $1" >&2
    exit 1
}

# ─────────────────────────────────────────────────────────────────────────────
# REGISTRATION HELPERS
# ─────────────────────────────────────────────────────────────────────────────

get_session_registration() {
    local session_id="${TF_SESSION_ID:-}"
    [[ -z "$session_id" ]] && return 1
    [[ ! -f "$REGISTRY_FILE" ]] && return 1

    local current_task=""
    local current_name=""

    while IFS=, read -r sid tid nm status ts; do
        [[ "$sid" != "$session_id" ]] && continue

        if [[ "$status" == "active" ]]; then
            current_task="$tid"
            current_name="$nm"
        elif [[ "$status" == "replaced" || "$status" == "left" || "$status" == "claimed" || "$status" == "cleared" ]]; then
            if [[ "$tid" == "$current_task" && "$nm" == "$current_name" ]]; then
                current_task=""
                current_name=""
            fi
        fi
    done < <(tail -n +2 "$REGISTRY_FILE")

    if [[ -n "$current_task" ]]; then
        echo "$current_task"
        return 0
    fi
    return 1
}

# Get all active agents for a task
get_active_agents() {
    local task="$1"
    [[ ! -f "$REGISTRY_FILE" ]] && return 0

    declare -A agent_status

    while IFS=, read -r sid tid nm status ts; do
        [[ "$tid" != "$task" ]] && continue

        if [[ "$status" == "active" ]]; then
            agent_status[$nm]="active"
        elif [[ "$status" == "replaced" || "$status" == "left" || "$status" == "claimed" || "$status" == "cleared" ]]; then
            unset agent_status[$nm] 2>/dev/null || true
        fi
    done < <(tail -n +2 "$REGISTRY_FILE")

    echo "${!agent_status[@]}"
}

# ─────────────────────────────────────────────────────────────────────────────
# TIME HELPERS
# ─────────────────────────────────────────────────────────────────────────────

parse_timestamp() {
    local ts="$1"
    date -j -f "%Y-%m-%d %H:%M:%S" "$ts" "+%s" 2>/dev/null || \
    date -j -f "%Y-%m-%dT%H:%M:%S" "$ts" "+%s" 2>/dev/null || \
    date -d "$ts" "+%s" 2>/dev/null || \
    echo "0"
}

format_time_ago() {
    local seconds="$1"
    if [[ $seconds -lt 60 ]]; then
        echo "${seconds}s ago"
    elif [[ $seconds -lt 3600 ]]; then
        echo "$((seconds / 60))m ago"
    elif [[ $seconds -lt 86400 ]]; then
        echo "$((seconds / 3600))h $((seconds % 3600 / 60))m ago"
    else
        echo "$((seconds / 86400))d ago"
    fi
}

# ─────────────────────────────────────────────────────────────────────────────
# MAIN
# ─────────────────────────────────────────────────────────────────────────────

main() {
    local task=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --help|-h)
                usage
                exit 0
                ;;
            -*)
                error "Unknown option: $1\nUse 'tf-status --help' for usage."
                ;;
            *)
                task="$1"
                shift
                ;;
        esac
    done

    # Get task from registration if not provided
    if [[ -z "$task" ]]; then
        task=$(get_session_registration 2>/dev/null) || true
        if [[ -z "$task" ]]; then
            error "No task specified and not registered.\nUsage: tf-status <task-id>"
        fi
    fi

    local task_dir="$TASKFORCE_ROOT/$task"
    if [[ ! -d "$task_dir" ]]; then
        error "Task '$task' does not exist.\nExpected directory: $task_dir"
    fi

    local chat_log="$task_dir/chat.log"
    local task_file="$task_dir/TASK.md"
    local now_epoch=$(date '+%s')

    # ─────────────────────────────────────────────────────────────────────────
    # HEADER
    # ─────────────────────────────────────────────────────────────────────────

    echo -e "${BOLD}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${BOLD}TASKFORCE STATUS: ${CYAN}$task${NC}"
    echo -e "${BOLD}═══════════════════════════════════════════════════════════${NC}"
    echo ""

    # ─────────────────────────────────────────────────────────────────────────
    # AGENTS
    # ─────────────────────────────────────────────────────────────────────────

    echo -e "${BOLD}Agents${NC}"

    # Get registered agents
    local registered_agents=$(get_active_agents "$task")

    if [[ -z "$registered_agents" ]]; then
        echo -e "  ${DIM}No agents registered${NC}"
    else
        # Parse chat log to get last activity per agent
        declare -A agent_last_time
        declare -A agent_last_type
        declare -A agent_entry_count

        if [[ -f "$chat_log" ]]; then
            while IFS= read -r line; do
                if [[ "$line" =~ ^###\ \[([0-9]{4}-[0-9]{2}-[0-9]{2}\ [0-9]{2}:[0-9]{2}:[0-9]{2})\]\ ([a-z]+)\ \|\ ([A-Z]+) ]]; then
                    local ts="${BASH_REMATCH[1]}"
                    local ag="${BASH_REMATCH[2]}"
                    local ty="${BASH_REMATCH[3]}"

                    agent_last_time[$ag]="$ts"
                    agent_last_type[$ag]="$ty"
                    agent_entry_count[$ag]=$((${agent_entry_count[$ag]:-0} + 1))
                fi
            done < "$chat_log"
        fi

        # Display each agent
        for agent in $registered_agents; do
            local last_time="${agent_last_time[$agent]:-}"
            local last_type="${agent_last_type[$agent]:-}"
            local entry_count="${agent_entry_count[$agent]:-0}"
            local time_ago=""
            local status_color="$NC"
            local silence_warning=""

            if [[ -n "$last_time" ]]; then
                local last_epoch=$(parse_timestamp "$last_time")
                local diff=$((now_epoch - last_epoch))
                time_ago=$(format_time_ago "$diff")

                # Color based on recency
                if [[ $diff -lt 300 ]]; then
                    status_color="$GREEN"
                elif [[ $diff -lt 600 ]]; then
                    status_color="$YELLOW"
                else
                    status_color="$RED"
                    silence_warning=" ${RED}!${NC}"
                fi
            else
                time_ago="no activity"
                status_color="$DIM"
            fi

            printf "  ${BOLD}%-8s${NC} " "$agent"
            if [[ -n "$last_type" ]]; then
                printf "${status_color}%-10s${NC} " "$last_type"
            else
                printf "${DIM}%-10s${NC} " "-"
            fi
            printf "%3d msgs | " "$entry_count"
            printf "${status_color}%s${NC}%s\n" "$time_ago" "$silence_warning"
        done
    fi
    echo ""

    # ─────────────────────────────────────────────────────────────────────────
    # REQUIREMENTS
    # ─────────────────────────────────────────────────────────────────────────

    echo -e "${BOLD}Requirements${NC}"

    if [[ -f "$task_file" ]]; then
        local total=0
        local done=0

        while IFS= read -r line; do
            if [[ "$line" =~ ^[[:space:]]*-[[:space:]]*\[[[:space:]]\] ]]; then
                total=$((total + 1))
            elif [[ "$line" =~ ^[[:space:]]*-[[:space:]]*\[[xX]\] ]]; then
                total=$((total + 1))
                done=$((done + 1))
            fi
        done < "$task_file"

        if [[ $total -eq 0 ]]; then
            echo -e "  ${DIM}No requirements defined${NC}"
        else
            local pct=0
            if [[ $total -gt 0 ]]; then
                pct=$((done * 100 / total))
            fi

            # Progress bar
            local bar_width=30
            local filled=$((pct * bar_width / 100))
            local empty=$((bar_width - filled))
            local bar=""
            for ((i=0; i<filled; i++)); do bar+="█"; done
            for ((i=0; i<empty; i++)); do bar+="░"; done

            local color="$RED"
            if [[ $pct -ge 100 ]]; then
                color="$GREEN"
            elif [[ $pct -ge 50 ]]; then
                color="$YELLOW"
            fi

            echo -e "  ${color}[$bar]${NC} $done/$total ($pct%)"

            # Show individual requirements
            echo ""
            while IFS= read -r line; do
                if [[ "$line" =~ ^[[:space:]]*-[[:space:]]*\[[[:space:]]\][[:space:]]*(.*) ]]; then
                    local req="${BASH_REMATCH[1]}"
                    req="${req#<!--}"
                    req="${req%-->}"
                    req="${req# }"
                    req="${req% }"
                    if [[ -n "$req" && "$req" != "Requirement"* ]]; then
                        echo -e "  ${RED}○${NC} $req"
                    fi
                elif [[ "$line" =~ ^[[:space:]]*-[[:space:]]*\[[xX]\][[:space:]]*(.*) ]]; then
                    local req="${BASH_REMATCH[1]}"
                    req="${req#<!--}"
                    req="${req%-->}"
                    req="${req# }"
                    req="${req% }"
                    if [[ -n "$req" && "$req" != "Requirement"* ]]; then
                        echo -e "  ${GREEN}●${NC} $req"
                    fi
                fi
            done < "$task_file"
        fi
    else
        echo -e "  ${DIM}No TASK.md found${NC}"
    fi
    echo ""

    # ─────────────────────────────────────────────────────────────────────────
    # RECENT ACTIVITY
    # ─────────────────────────────────────────────────────────────────────────

    echo -e "${BOLD}Recent Activity${NC}"

    if [[ -f "$chat_log" ]]; then
        local entries=()
        local current_ts=""
        local current_agent=""
        local current_type=""
        local current_msg=""
        local in_entry=false

        while IFS= read -r line || [[ -n "$line" ]]; do
            if [[ "$line" =~ ^###\ \[([0-9]{4}-[0-9]{2}-[0-9]{2}\ [0-9]{2}:[0-9]{2}:[0-9]{2})\]\ ([a-z]+)\ \|\ ([A-Z]+) ]]; then
                if [[ "$in_entry" == true ]]; then
                    entries+=("$current_ts|$current_agent|$current_type|$current_msg")
                fi
                in_entry=true
                current_ts="${BASH_REMATCH[1]}"
                current_agent="${BASH_REMATCH[2]}"
                current_type="${BASH_REMATCH[3]}"
                current_msg=""
            elif [[ "$in_entry" == true && -n "$line" ]]; then
                if [[ -z "$current_msg" ]]; then
                    current_msg="$line"
                fi
            fi
        done < "$chat_log"

        if [[ "$in_entry" == true ]]; then
            entries+=("$current_ts|$current_agent|$current_type|$current_msg")
        fi

        local count=${#entries[@]}
        if [[ $count -eq 0 ]]; then
            echo -e "  ${DIM}No activity yet${NC}"
        else
            # Show last 5 entries
            local start=$((count - 5))
            [[ $start -lt 0 ]] && start=0

            for ((i = count - 1; i >= start; i--)); do
                local entry="${entries[$i]}"
                local ts=$(echo "$entry" | cut -d'|' -f1)
                local ag=$(echo "$entry" | cut -d'|' -f2)
                local ty=$(echo "$entry" | cut -d'|' -f3)
                local msg=$(echo "$entry" | cut -d'|' -f4-)

                local time_only=$(echo "$ts" | cut -d' ' -f2)

                # Truncate message
                msg=$(echo "$msg" | tr '\n' ' ' | sed 's/  */ /g')
                msg="${msg:0:45}"
                [[ ${#msg} -ge 45 ]] && msg="$msg..."

                echo -e "  ${CYAN}[$time_only]${NC} ${BOLD}$ag${NC} | $ty - $msg"
            done
        fi
    else
        echo -e "  ${DIM}No chat log found${NC}"
    fi
    echo ""

    # ─────────────────────────────────────────────────────────────────────────
    # ALERTS
    # ─────────────────────────────────────────────────────────────────────────

    local has_alerts=false

    # Check for silent agents (> 10 minutes)
    if [[ -n "$registered_agents" && -f "$chat_log" ]]; then
        declare -A agent_last_epoch
        while IFS= read -r line; do
            if [[ "$line" =~ ^###\ \[([0-9]{4}-[0-9]{2}-[0-9]{2}\ [0-9]{2}:[0-9]{2}:[0-9]{2})\]\ ([a-z]+)\ \| ]]; then
                local ts="${BASH_REMATCH[1]}"
                local ag="${BASH_REMATCH[2]}"
                agent_last_epoch[$ag]=$(parse_timestamp "$ts")
            fi
        done < "$chat_log"

        for agent in $registered_agents; do
            local last_epoch="${agent_last_epoch[$agent]:-0}"
            local silence=$((now_epoch - last_epoch))

            if [[ $silence -gt 600 ]]; then
                if [[ "$has_alerts" == false ]]; then
                    echo -e "${YELLOW}${BOLD}Alerts${NC}"
                    has_alerts=true
                fi
                local silence_mins=$((silence / 60))
                echo -e "  ${YELLOW}!${NC} ${BOLD}$agent${NC} has been silent for ${silence_mins}m"
            fi
        done
    fi

    if [[ "$has_alerts" == true ]]; then
        echo ""
    fi
}

main "$@"
